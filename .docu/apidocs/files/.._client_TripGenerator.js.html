<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../client/TripGenerator.js - TripGenerator</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="TripGenerator"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Car.html">Car</a></li>
            
                <li><a href="../classes/Direction.html">Direction</a></li>
            
                <li><a href="../classes/Place.html">Place</a></li>
            
                <li><a href="../classes/Simulation.html">Simulation</a></li>
            
                <li><a href="../classes/Trip.html">Trip</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Simulation.html">Simulation</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ../client/TripGenerator.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
Places = new Array();
var map;
var currentMarker;
var markers = new Array();

function log(p) {
  console.log(p);
}

Meteor.startup(function() {
  initGoogleMaps();
  initGoogleMapsSearchBox();
  currentMarker = new google.maps.Marker({ map: map });
});

Meteor.methods({
  updateCars: function(projectId, placesIndex) {
    log(&quot;Updating Cars in Project: &quot;+projectId+&quot; on places: &quot;+placesId);

  }
});

Template.projectsView.projects = function() {
  return Projects.find();
};

Template.projectsView.list_status = function() {
  if (Session.equals(&#x27;current_project&#x27;, this._id)) return &quot; info&quot;;
  else return &quot;&quot;;
};

Template.projectsView.events({
  &#x27;click #newProjectBtn&#x27;: function(e, t) {
    var projname = String(t.find(&#x27;#newProjectField&#x27;).value || &quot;&quot;);
    if(projname) {
      Projects.insert({name: projname});
      t.find(&#x27;#newProjectField&#x27;).value = &quot;&quot;;
    }
  },
  &#x27;keyup #newProjectField&#x27;: function(e, t) {
    if(e.which === 13) {
      var projname = String(e.target.value || &quot;&quot;);
      if(projname) {
        Projects.insert({name: projname});
        e.target.value = &quot;&quot;;
      }
    }
  },
  &#x27;click .projectEntry&#x27;: function(e, t) {
    Session.set(&#x27;current_project&#x27;, this._id);
  }
});

Template.maps.events({
  &#x27;click #newPlaceBtn&#x27;: function(e, t) {
    if(isProjectSelected()) {
      Projects.update({_id: Session.get(&#x27;current_project&#x27;)}, {$addToSet:{ places: {id: currentMarker.get(&quot;name&quot;).hashCode() ,name: currentMarker.get(&quot;name&quot;), cars: 15, km: 1500, location: {long: currentMarker.getPosition().lng(), lat: currentMarker.getPosition().lat()}}}});
      currentMarker.setMap(null);
      document.getElementById(&#x27;gmSearchTextField&#x27;).value = &quot;&quot;;
    } else {
      console.log(&quot;Kein Projekt ausgewählt!&quot;);
    }
  }
});

Template.projectInspector.rendered = function() {
  var spinnerCars = this.findAll(&#x27;.spinner-car&#x27;);
  var spinnerKm = this.findAll(&#x27;.spinner-km&#x27;);
  for(var i = 0; i &lt; (spinnerCars.length); i++) {
    var element = spinnerCars[i];
    $(&quot;#&quot;+element.id+&quot;.spinner-car&quot;).spinner({value: parseInt((element.getAttribute(&#x27;data-value&#x27;) ? element.getAttribute(&#x27;data-value&#x27;) : 20))});
  }
  for(var i = 0; i &lt; (spinnerKm.length); i++) {
    var element = spinnerKm[i];
    $(&quot;#&quot;+element.id+&quot;.spinner-km&quot;).spinner({value: parseInt((element.getAttribute(&#x27;data-value&#x27;) ? element.getAttribute(&#x27;data-value&#x27;) : 20)), max: 9999, step: 100}); 
  }
};

Template.projectInspector.places = function() {
  if(Session.equals(&#x27;current_project&#x27;, null)) return null;
  else {
    var project = Projects.findOne({_id: Session.get(&#x27;current_project&#x27;)});
    if(project &amp;&amp; project.places) {
      markers = new Array();
      clearMarkers();
      for(var i = 0; i &lt; project.places.length; i++) {
        p = project.places[i];
        latlng = new google.maps.LatLng(p.location.lat, p.location.long),
        markers[i] = new google.maps.Marker({
          position: latlng,
          map: map,
          id: p.id
        });
      }
      return project.places;
    }
  }
};

Template.projectInspector.project_selected = function() {
  return isProjectSelected();
};

Template.projectInspector.events({
  &#x27;click a.removeMarker&#x27;: removeMarker,
  &#x27;click a.focusMarker&#x27;: focusMarker,
  &#x27;click #startSimulation&#x27;: startSimulation
});

// HelferMethoden

function outputMessage(string) {
  log(string);
  $(&#x27;#simulationOutputBox&#x27;).append(&#x27;&lt;p&gt;&#x27;+string+&#x27;&lt;/p&gt;&#x27;);
}

function outputError(string) {
  log(string);
  $(&#x27;#simulationOutputBox&#x27;).append(&#x27;&lt;p font-color=&quot;red&quot;&gt;&#x27;+string+&#x27;&lt;/p&gt;&#x27;);
}

function startSimulation(e, t) {
  $(&#x27;#simulationModal&#x27;).modal();
  outputMessage(&quot;Starte Simulation...&quot;);
  outputMessage(&quot;Hole googlemaps Directions Daten&quot;);
  getGMDirections();
}

function startWebworker(GMDResponse) {
  var worker = new Worker(&#x27;simulation.js&#x27;);
  worker.addEventListener(&#x27;message&#x27;, onWorkerMessage, false);
  worker.addEventListener(&#x27;error&#x27;, onWorkerError, false);
  var project = Projects.findOne({_id: Session.get(&#x27;current_project&#x27;)});
  worker.postMessage({&#x27;cmd&#x27;: &#x27;start&#x27;, &#x27;parameters&#x27;: {gmdirections: GMDResponse, places: project.places}});  
}

/**
 *  Nachricht vom Worker
 */
function onWorkerMessage(e) {
  switch(e.data.cmd) {
    case &#x27;msg&#x27;:
      outputMessage(e.data.parameters.text);
    break;
    case &#x27;data&#x27;:
      log(JSON.parse(e.data.parameters.data));
    break;
    default:
      log(&#x27;Waaatt?&#x27;);
    break;
  } 
}

/**
 *  Error vom Worker
 */
function onWorkerError(e) {
  outputError(e.data);
}

/**
 *  Verknüpft jeden Standort miteinander und erzeugt ein googleMapsLatLng-Objekt
 */
function preparePlacesForGMDirections(places) {
  if(places) {
    var numberOfPlacesTotal = places.length;
    var origins = new Array();
    var destinations = new Array();
    for (var i = 0; i &lt; places.length; i++) {
      origins.push(new google.maps.LatLng(places[i].location.lat, places[i].location.long));
      destinations.push(new google.maps.LatLng(places[i].location.lat, places[i].location.long));
    }
  }
  return new Array(origins, destinations);
}

/**
 *  Sendet die Orte and den google-Directions Service und schickt die Antwort an ein Callback
 */
function getGMDirections(projectID) {
  var project = Projects.findOne({_id: Session.get(&#x27;current_project&#x27;)});
  var oAndD = preparePlacesForGMDirections(project.places);
  var service = new google.maps.DistanceMatrixService();
  service.getDistanceMatrix(
    {
      origins: oAndD[0],
      destinations: oAndD[1],
      travelMode: google.maps.TravelMode.DRIVING,
      avoidHighways: false,
      avoidTolls: false
    }, GMDirectionsResponse);
}

/** 
 *  Callback für die google-Directions anfrage.
 */
function GMDirectionsResponse(response, status) {
  outputMessage(&quot;googlemaps Directions: &quot;+status);
  if(status === &quot;OK&quot;) startWebworker(response);
  else outputMessage(&quot;googelmaps Directions Fehler. Simulation abgebrochen.&quot;);
}

function removeMarker(e, t) {
  e.preventDefault();
  var mid = parseInt(e.target.getAttribute(&#x27;data-markerid&#x27;),10);
  Projects.update({_id:Session.get(&#x27;current_project&#x27;)}, {$pull: {places: {id: mid}}});
};

function focusMarker(e, t) {
  e.preventDefault();
  var mid = parseInt(e.target.getAttribute(&#x27;data-markerid&#x27;),10);
  var temp = _.find(markers, function(i) {
   return (i.id === mid);
  });
  map.setCenter(temp.getPosition());
  map.setZoom(12);
};

function initGoogleMaps() {
  console.log(&quot;Initialisieren Googlemaps&quot;);
  var mapOptions = {
    center: new google.maps.LatLng(49.000, 10.2652),
    zoom: 7,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    streetViewControl: false
  };
  map = new google.maps.Map(document.getElementById(&quot;googlemaps&quot;), mapOptions);
};

function clearMarkers() {
  for (var i = 0; i &lt; markers.length; i++ ) {
    markers[i].setMap(null);
  }
};

function initGoogleMapsSearchBox() {
  var input = document.getElementById(&#x27;gmSearchTextField&#x27;);
  var autocomplete = new google.maps.places.Autocomplete(input);

  autocomplete.bindTo(&#x27;bound&#x27;, map);

  var infowindow = new google.maps.InfoWindow();

  google.maps.event.addListener(autocomplete, &#x27;place_changed&#x27;, function() {
    infowindow.close();
    currentMarker.setVisible(false);
    input.className = &#x27;&#x27;;
    var place = autocomplete.getPlace();
    if(!place.geometry) {
      //Benutzer informieren das der Platz nicht gefunden wurde
      input.className = &#x27;notfound&#x27;;
      return
    }

    //Wenn Daten über ein Platz vorhaden, kann man ihn anzeigen
    if(place.geometry.viewport) {
      map.fitBounds(place.geometry.viewport);
    } else {
      map.setCenter(place.geometry.location);
      map.setZoom(17);
    }
    var image = {
      url: place.icon,
      size: new google.maps.Size(71, 71),
      origin: new google.maps.Point(0, 0),
      anchor: new google.maps.Point(17, 34),
      scaledSize: new google.maps.Size(35, 35)
    };
    currentMarker.set(&quot;name&quot;, input.value);
    currentMarker.setIcon(image);
    currentMarker.setPosition(place.geometry.location);
    currentMarker.setVisible(true);
  });
};

function isProjectSelected() {
  return ((Session.get(&#x27;current_project&#x27;) != null) &amp;&amp; (!Session.equals(&#x27;current_project&#x27;, null)));
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
